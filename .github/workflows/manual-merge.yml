name: "Robot: Manual Merge Pull Request"

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: '‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Pull Request (‡πÄ‡∏ä‡πà‡∏ô 12)'
        required: true
        type: number

      merge_method:
        description: '‡∏ß‡∏¥‡∏ò‡∏µ merge'
        required: true
        type: choice
        options:
          - squash
          - merge
          - rebase

permissions:
  pull-requests: write
  contents: write

jobs:
  manual-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
        run: |
          echo "üîß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞ merge PR #${{ github.event.inputs.pr_number }}"
          echo "‚û°Ô∏è ‡∏ß‡∏¥‡∏ò‡∏µ merge: ${{ github.event.inputs.merge_method }}"
          echo "üë§ ‡∏™‡∏±‡πà‡∏á‡πÇ‡∏î‡∏¢: ${{ github.actor }}"

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install gh -y

      - name: Merge Pull Request (Manual)
        env:
          GH_TOKEN: ${{ secrets.SECRET_PAT }}
        run: |
          ISSUE_NUMBER=$(gh pr view ${{ github.event.inputs.pr_number }} \
            --json title \
            -q '.title' | grep -oE '[0-9]+')

          echo "Detected issue number: $ISSUE_NUMBER"

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç issue ‡πÉ‡∏ô PR title"
            exit 1
          fi

          gh pr merge ${{ github.event.inputs.pr_number }} \
            --${{ github.event.inputs.merge_method }} \
            --delete-branch \
            --body "closes #$ISSUE_NUMBER"
