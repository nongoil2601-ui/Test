name: Auto Create Pull Request and Link Issue

on:
  push:
    branches-ignore:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pull-request:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install gh -y

      - name: Extract Issue Number from Branch
        id: extract
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          ISSUE_NUM=$(echo "$BRANCH_NAME" | grep -oE '[0-9]+' | head -n 1)

          if [ -z "$ISSUE_NUM" ]; then
            echo "❌ ไม่พบเลข Issue ในชื่อ branch"
            exit 1
          fi

          echo "NUM=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "✅ เจอเลข Issue: $ISSUE_NUM"

      - name: Create Pull Request
        id: cpr_step
        uses: repo-sync/pull-request@v2
        with:
          source_branch: ${{ github.ref_name }}
          destination_branch: main
          pr_title: "PR: รวมงานจากเครื่องของคุณ #${{ steps.extract.outputs.NUM }}"
          pr_body: |
            สร้างอัตโนมัติโดย GitHub Action

            closes #${{ steps.extract.outputs.NUM }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Result
        run: |
          if [ -z "${{ steps.cpr_step.outputs.pr_number }}" ]; then
            echo "⚠️ ไม่มีการสร้าง PR (อาจไม่มี diff)"
          else
            echo "✅ สร้าง PR หมายเลข ${{ steps.cpr_step.outputs.pr_number }}"
          fi
