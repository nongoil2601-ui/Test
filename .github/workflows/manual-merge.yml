name: "Robot: Manual Merge Pull Request test"

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: '‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Pull Request (‡πÄ‡∏ä‡πà‡∏ô 12)'
        required: true
        type: number

      merge_method:
        description: '‡∏ß‡∏¥‡∏ò‡∏µ merge'
        required: true
        type: choice
        options:
          - squash
          - merge
          - rebase

permissions:
  pull-requests: write
  contents: write

jobs:
  manual-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install gh -y

      - name: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
        run: |
          echo "üîß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞ merge PR #${{ github.event.inputs.pr_number }}"
          echo "‚û°Ô∏è ‡∏ß‡∏¥‡∏ò‡∏µ merge: ${{ github.event.inputs.merge_method }}"
          echo "üë§ ‡∏™‡∏±‡πà‡∏á‡πÇ‡∏î‡∏¢: ${{ github.actor }}"

      - name: Add close issue keyword to PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM=${{ github.event.inputs.pr_number }}

          # 1. ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠ branch ‡∏Ç‡∏≠‡∏á PR (‡πÄ‡∏ä‡πà‡∏ô l-169)
          BRANCH=$(gh pr view "$PR_NUM" --json headRefName -q .headRefName)
          echo "üìå PR branch: $BRANCH"

          # 2. ‡∏î‡∏∂‡∏á issue number ‡∏à‡∏≤‡∏Å branch
          ISSUE_NUM=$(echo "$BRANCH" | grep -oE '[0-9]+' | head -n 1)

          [ -z "$ISSUE_NUM" ]; then
            echo "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö issue number ‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠ branch"
            exit 1
          fi

          echo "‚úÖ ‡∏û‡∏ö issue: #$ISSUE_NUM"

          # 3. ‡∏î‡∏∂‡∏á PR body
          BODY=$(gh pr view "$PR_NUM" --json body -q .body)

          # 4. ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥
          if echo "$BODY" | grep -q "closes #$ISSUE_NUM"; then
            echo "‚ÑπÔ∏è PR body ‡∏°‡∏µ closes #$ISSUE_NUM ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß"
            exit 0
          fi

          # 5. ‡πÄ‡∏û‡∏¥‡πà‡∏° closes keyword
          NEW_BODY="${BODY}

          closes #${ISSUE_NUM}"

          gh pr edit "$PR_NUM" --body "$NEW_BODY"

      - name: Merge Pull Request (Manual)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ github.event.inputs.pr_number }} \
            --${{ github.event.inputs.merge_method }}
