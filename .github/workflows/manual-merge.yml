name: "Robot: Manual Merge Pull Request"

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'à¸£à¸°à¸šà¸¸à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚ Pull Request (à¹€à¸Šà¹ˆà¸™ 12)'
        required: true
        type: number

      merge_method:
        description: 'à¸§à¸´à¸˜à¸µ merge'
        required: true
        type: choice
        options:
          - squash
          - merge
          - rebase

permissions:
  pull-requests: write
  contents: write
  issues: write  # <--- [à¸ªà¸³à¸„à¸±à¸] à¸•à¹‰à¸­à¸‡à¸‚à¸­à¸ªà¸´à¸—à¸˜à¸´à¹Œà¹à¸à¹‰à¹„à¸‚ Issue à¹€à¸žà¸´à¹ˆà¸¡

jobs:
  manual-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸³à¸ªà¸±à¹ˆà¸‡
        run: |
          echo "ðŸ”§ à¸à¸³à¸¥à¸±à¸‡à¸ˆà¸° merge PR #${{ github.event.inputs.pr_number }}"
          echo "âž¡ï¸ à¸§à¸´à¸˜à¸µ merge: ${{ github.event.inputs.merge_method }}"
          echo "ðŸ‘¤ à¸ªà¸±à¹ˆà¸‡à¹‚à¸”à¸¢: ${{ github.actor }}"

      - name: Merge Pull Request (Manual)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ github.event.inputs.pr_number }} \
            --${{ github.event.inputs.merge_method }}

# 2. [à¹€à¸žà¸´à¹ˆà¸¡à¹ƒà¸«à¸¡à¹ˆ] à¸„à¹‰à¸™à¸«à¸²à¹€à¸¥à¸‚ Issue à¸ˆà¸²à¸ PR à¹à¸¥à¹‰à¸§à¸ªà¸±à¹ˆà¸‡à¸›à¸´à¸”à¸—à¸±à¸™à¸—à¸µ!
      - name: Force Close Linked Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” à¸à¸³à¸¥à¸±à¸‡à¸„à¹‰à¸™à¸«à¸² Issue à¸—à¸µà¹ˆà¸œà¸¹à¸à¸à¸±à¸š PR à¸™à¸µà¹‰..."
          
          # à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ Body à¸‚à¸­à¸‡ PR à¸¡à¸²à¸”à¸¹
          PR_BODY=$(gh pr view ${{ github.event.inputs.pr_number }} --json body --jq .body)
          
          # à¹ƒà¸Šà¹‰à¸ªà¸¹à¸•à¸£à¸„à¹‰à¸™à¸«à¸²à¸„à¸³à¸§à¹ˆà¸² "Closes #à¹€à¸¥à¸‚"
          ISSUE_NUM=$(echo "$PR_BODY" | sed -n 's/.*[Cc]loses #[^0-9]*\([0-9]\+\).*/\1/p' | head -n 1)

          if [ -n "$ISSUE_NUM" ]; then
            echo "âœ… à¹€à¸ˆà¸­ Issue à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸›à¸´à¸” à¸„à¸·à¸­ #$ISSUE_NUM"
            gh issue close "$ISSUE_NUM" --comment "Auto-closed by Robot Merge ðŸ¤–"
          else
            echo "âš ï¸ à¹„à¸¡à¹ˆà¸žà¸š Issue à¸—à¸µà¹ˆà¸œà¸¹à¸à¸à¸±à¸š PR à¸™à¸µà¹‰"
          fi
