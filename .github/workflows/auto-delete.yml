name: "Robot: Auto Delete Branch"

on:
  pull_request:
    types: [closed]
  workflow_call: # เพิ่มเข้ามาเหมือนรอให้คนมาโทร เพื่อทำหน้าที่

jobs:
  auto-delete-branch:
    # เงื่อนไข: ถ้าเป็น PR ปิดแล้ว Merge จริง หรือ ถ้าถูกเรียกมาจากการ Push (ที่ไม่ใช่ Main)
    if: ${{ (github.event.pull_request.merged == true) || (github.event_name == 'push' && github.ref_name != 'main') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: "1. ตรวจสอบชื่อ branch ที่จะลบ"
        run: |
          TARGET="${{ github.event.pull_request.head.ref || github.ref_name }}"
          echo "PR ถูก Merge แล้ว! กำลังเตรียมลบ branch: $TARGET"
          
          # ป้องกันไม่ให้ลบกิ่งหลัก (เผื่อไว้)
          if [ "$TARGET" == "main" ] || [ "$TARGET" == "develop" ]; then
            echo "ไม่สามารถลบกิ่งหลักได้"
            exit 0
          fi
          echo "target_branch=$TARGET" >> $GITHUB_ENV

      - name: "2. สั่งลบ branch อัตโนมัติ"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api -X DELETE "/repos/${{ github.repository }}/git/refs/heads/${{ env.target_branch }}"