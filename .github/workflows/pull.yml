name: Auto Create Pull Request and Merge PR
on:
  push:
    branches-ignore:
      - main
  
jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    permissions: 
      contents: write
      pull-requests: write
      statuses: write
    outputs:
      pr_number: ${{ steps.cpr_step.outputs.pr_number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install gh -y

      # [NEW] ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÅ‡∏Å‡∏∞‡πÄ‡∏•‡∏Ç Issue ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠ Branch
      - name: Prepare PR Data
        id: prep
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ä‡∏∏‡∏î‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠ Branch
          ISSUE_NUM=$(echo "$BRANCH_NAME" | grep -oE '[0-9]+' | head -n 1)
          
          if [ -n "$ISSUE_NUM" ]; then
            echo "‚úÖ ‡πÄ‡∏à‡∏≠‡πÄ‡∏•‡∏Ç Issue: $ISSUE_NUM"
            # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡πÄ‡∏•‡∏Ç ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Closes #...
            echo "BODY_CONTENT=Auto-generated by GitHub Action<br/>Closes #$ISSUE_NUM" >> $GITHUB_OUTPUT
            echo "TITLE_TEXT=PR: ${{ github.ref_name }} (Issue #$ISSUE_NUM)" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÄ‡∏•‡∏Ç Issue ‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠ Branch"
            # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÄ‡∏•‡∏Ç ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Closes
            echo "BODY_CONTENT=Auto-generated by GitHub Action" >> $GITHUB_OUTPUT
            echo "TITLE_TEXT=PR: ${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á PR
      - name: Create Pull Request
        id: cpr_step
        uses: repo-sync/pull-request@v2
        with:
          source_branch: ${{ github.ref_name }}
          destination_branch: "main"
          pr_title: "PR: ‡∏£‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì #${{ steps.prep.outputs.TITLE_TEXT }}"
          pr_body: |
            ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏°‡∏£‡πà‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢ GitHub Action 
            closes #${{ steps.prep.outputs.TITLE_TEXT }}
          github_token: ${{ secrets.GITHUB_TOKEN }}  
     
      # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏´‡∏°?
      - name: Check for changes
        run: |
          if [ -z "${{ steps.cpr_step.outputs.pr_number }}" ]; then
            echo "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á (‡πÑ‡∏ü‡∏•‡πå‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô)"
            echo "‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Merge ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô"
          else
            echo "‚úÖ ‡∏û‡∏ö‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà! ‡∏™‡∏£‡πâ‡∏≤‡∏á PR ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${{ steps.cpr_step.outputs.pr_number }} ‡πÅ‡∏•‡πâ‡∏ß"
          fi

      # # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏™‡∏±‡πà‡∏á Merge ‡πÅ‡∏•‡∏∞‡∏•‡∏ö Branch ‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ üóëÔ∏è
      # - name: Merge Pull Request
      #   if: ${{ steps.cpr_step.outputs.pr_number }}
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     echo "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Merge PR ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${{ steps.cpr_step.outputs.pr_number }}..."
          
      #     # ‡πÄ‡∏û‡∏¥‡πà‡∏° --delete-branch ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏Å‡∏¥‡πà‡∏á oil ‡∏ö‡∏ô GitHub ‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏á‡∏≤‡∏ô
      #     gh pr merge ${{ steps.cpr_step.outputs.pr_number }} --merge --auto --delete-branch