name: Auto Create Pull Request and Merge
on:
  push:
    branches-ignore:
      - main  # ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Å‡∏¥‡πà‡∏á ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô main
  
jobs:
  create-and-merge:
    runs-on: ubuntu-latest
    permissions: 
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á PR
      - name: Create Pull Request
        id: cpr_step
        uses: repo-sync/pull-request@v2
        with:
          source_branch: ${{ github.ref_name }}
          destination_branch: "main"
          pr_title: "Auto-Merge: ‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏¥‡πà‡∏á ${{ github.ref_name }}"
          pr_body: "‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ‡∏™‡∏£‡πâ‡∏≤‡∏á PR, Merge ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏•‡∏ö‡∏Å‡∏¥‡πà‡∏á‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_allow_empty: false 

      # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç PR (‡∏Ñ‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πä‡∏∞) ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°
      - name: Check output
        run: |
          if [ -z "${{ steps.cpr_step.outputs.pr_number }}" ]; then
            echo "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á ‡∏´‡∏£‡∏∑‡∏≠ PR ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß"
          else
            echo "‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á PR ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${{ steps.cpr_step.outputs.pr_number }} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"
          fi

      # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏™‡∏±‡πà‡∏á Merge ‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏Å‡∏¥‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      - name: Merge and Delete Branch
        # ‡∏ó‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏•‡∏Ç PR ‡∏™‡πà‡∏á‡∏°‡∏≤
        if: ${{ steps.cpr_step.outputs.pr_number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á Merge PR ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${{ steps.cpr_step.outputs.pr_number }}..."
          
          # ‡πÉ‡∏ä‡πâ --merge (‡πÅ‡∏ö‡∏ö merge commit) ‡πÅ‡∏•‡∏∞ --delete-branch (‡∏•‡∏ö‡∏Å‡∏¥‡πà‡∏á)
          # ‡∏ï‡∏±‡∏î --auto ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏±‡πà‡∏á Merge ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          gh pr merge ${{ steps.cpr_step.outputs.pr_number }} --merge --delete-branch
          
          echo "‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏£‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ Main ‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏Å‡∏¥‡πà‡∏á ${{ github.ref_name }} ‡πÅ‡∏•‡πâ‡∏ß"